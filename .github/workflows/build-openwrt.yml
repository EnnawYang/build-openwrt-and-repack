name: Build OpenWrt

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      rm_dl:
        description: 'delete dl floder [true/false]'
        required: true
        default: 'false'
      tar:
        description: 'upload openwrt .tar to GoogleDrive [true/false]'
        required: true
        default: 'true'
      release_note:
        description: 'release note'
        required: true
        default: 'update'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  REPO_FLODER: openwrt
  CONFIG_REPO: https://github.com/EnnawYang/Actions-OpenWrt
  CONFIG_BRANCH: main
  CONFIG_FLODER: Actions-OpenWrt
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  Notification: true
  TZ: Asia/Shanghai

jobs:
  x86_64:
    runs-on: ubuntu-20.04

    steps:
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo ln -fs /usr/share/zoneinfo/$TZ /etc/localtime
        sudo dpkg-reconfigure -f noninteractive tzdata
        echo "TARGET_NAME=${{ github.job.container.id }}" >> $GITHUB_ENV
        echo "RM_DL=${{ github.event.inputs.rm_dl }}" >> $GITHUB_ENV
        echo "TAR=${{ github.event.inputs.tar }}" >> $GITHUB_ENV

    - name: Echo env
      if: (!cancelled())
      run: echo -e "$TARGET_NAME"

    - name: Notification
      if: env.Notification == 'true' && !cancelled()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage -d chat_id=${{ secrets.TG_CHAT_ID }} -d text=""$TARGET_NAME" TEST DONE." 2>&1 >/dev/null || echo "Telegram notification failed"
